<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>نظام جرد الإعاشة الذكي | Jarda</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (To compile JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- XLSX (Excel Export) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Tajawal', 'sans-serif'] },
            colors: {
              primary: '#0f766e',
              secondary: '#f59e0b',
            }
          }
        }
      }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
      body { background-color: #f9fafb; font-family: 'Tajawal', sans-serif; }
      .animate-in { animation-duration: 0.2s; animation-fill-mode: both; }
      .fade-in { animation-name: fadeIn; }
      .zoom-in-95 { animation-name: zoomIn95; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes zoomIn95 { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
      .spin { animation: spin 1s linear infinite; }
      @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
    "xlsx": "https://aistudiocdn.com/xlsx@^0.18.5"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useRef } = React;

        // --- ICONS (Wrapped in Fragments to fix syntax error) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                LayoutDashboard: <path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/>,
                Users: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
                Building2: <><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></>,
                ArrowRight: <><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></>,
                ArrowLeft: <><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></>,
                Plus: <><path d="M12 5v14"/><path d="M5 12h14"/></>,
                Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
                Edit2: <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>,
                RefreshCcw: <><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></>,
                Settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
                X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
                Eye: <><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>,
                Box: <><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></>,
                Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
                Unlock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></>,
                FileEdit: <><path d="M4 13.5V4a2 2 0 0 1 2-2h8.5L20 7.5V20a2 2 0 0 1-2 2h-5.5"/><polyline points="14 2 14 8 20 8"/><path d="M10.42 12.61a2.1 2.1 0 1 1 2.97 2.97L7.95 21 4 22l.99-3.95 5.43-5.44Z"/></>,
                FileSpreadsheet: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></>,
                Calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>,
                CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
                Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>,
                Send: <><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
                AlertTriangle: <><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></>,
                Loader2: <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        // --- SAFE STORAGE (Prevents crashes if browser blocks LocalStorage) ---
        const safeStorage = {
            getItem: (key) => { try { return localStorage.getItem(key); } catch(e) { return null; } },
            setItem: (key, val) => { try { localStorage.setItem(key, val); } catch(e) {} }
        };

        // --- API SERVICE (Direct Fetch) ---
        // REPLACE WITH YOUR KEY HERE IF NEEDED
        const API_KEY = ""; 
        
        const checkInventoryAnomaly = async (itemName, unit, quantity) => {
            if (!API_KEY) return { isSuspicious: false };
            
            try {
                const promptText = `Item: "${itemName}", Unit: "${unit}", Entered Qty: ${quantity}. Is this quantity highly suspicious/impossible for a weekly catering inventory (e.g. 5000kg salt)? Return JSON: { "isSuspicious": boolean, "reason": "Arabic text" }`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                         contents: [{ parts: [{ text: promptText }] }]
                    })
                });

                if (!response.ok) throw new Error("API Request Failed");

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) return { isSuspicious: false };
                
                // Extract JSON from text (sometimes model adds Markdown backticks)
                const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const result = JSON.parse(jsonStr);
                return { isSuspicious: result.isSuspicious, message: result.reason };
            } catch (error) {
                console.warn("AI Check Failed", error);
                return { isSuspicious: false };
            }
        };

        // --- COMPONENTS ---

        const Button = ({ children, variant = 'primary', fullWidth = false, className = '', ...props }) => {
            const variants = {
                primary: "bg-primary text-white hover:bg-teal-800 shadow-md",
                secondary: "bg-secondary text-white hover:bg-amber-600 shadow-md",
                danger: "bg-red-500 text-white hover:bg-red-600",
                outline: "border-2 border-primary text-primary hover:bg-teal-50"
            };
            return (
                <button className={`px-4 py-2 rounded-lg font-medium transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 ${variants[variant]} ${fullWidth ? 'w-full' : ''} ${className}`} {...props}>
                    {children}
                </button>
            );
        };

        const SupervisorDashboard = ({ session, items, onUpdateSession, onExit }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [localEntries, setLocalEntries] = useState(session.entries || {});
            const [isChecking, setIsChecking] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [warningMessage, setWarningMessage] = useState(null);
            const [viewMode, setViewMode] = useState('focus');
            const [saveStatus, setSaveStatus] = useState('idle');
            const [showSubmitConfirm, setShowSubmitConfirm] = useState(false);

            useEffect(() => { setLocalEntries(session.entries || {}); }, [session]);

            const currentItem = items[currentIndex];
            if (!currentItem && items.length > 0) { setCurrentIndex(0); return null; }
            if (items.length === 0) return <div className="p-8 text-center">لا يوجد مواد.<Button onClick={onExit} className="mt-4">خروج</Button></div>;

            const currentEntry = localEntries[currentItem.id] || { itemId: currentItem.id, quantity: null };

            const handleNext = async () => {
                const qty = currentEntry.quantity;
                if (qty !== null && qty !== undefined && !warningMessage) {
                    let isSuspicious = false;
                    let message = '';
                    // 1. Min/Max Check
                    if (currentItem.minQuantity && (qty < currentItem.minQuantity || qty > currentItem.maxQuantity)) {
                        isSuspicious = true;
                        message = `الكمية خارج المدى (${currentItem.minQuantity}-${currentItem.maxQuantity}). متأكد؟`;
                    }
                    // 2. AI Check (Fallback)
                    else if (qty > 50) {
                        setIsChecking(true);
                        const check = await checkInventoryAnomaly(currentItem.name, currentItem.unit, qty);
                        setIsChecking(false);
                        if (check.isSuspicious) { isSuspicious = true; message = check.message; }
                    }

                    if (isSuspicious) { setWarningMessage(message); return; }
                }
                setWarningMessage(null);
                if (currentIndex < items.length - 1) setCurrentIndex(prev => prev + 1);
                else setViewMode('list');
            };

            const handleSaveDraft = () => {
                setIsSaving(true);
                setTimeout(() => {
                    onUpdateSession({ ...session, entries: localEntries, status: 'active' });
                    setIsSaving(false);
                    setSaveStatus('saved');
                    setTimeout(() => setSaveStatus('idle'), 2000);
                }, 500);
            };

            const confirmSubmit = () => {
                setShowSubmitConfirm(false);
                setIsSaving(true);
                onUpdateSession({ ...session, entries: localEntries, status: 'submitted' });
            };

            // Focus Mode View
            if (viewMode === 'focus') {
                return (
                    <div className="max-w-md mx-auto flex flex-col min-h-screen bg-gray-50 pb-20">
                        <div className="flex justify-between items-center p-4">
                            <button onClick={() => setViewMode('list')} className="text-sm text-primary font-bold underline">عرض القائمة</button>
                            <span className="text-gray-500 text-sm">{currentIndex + 1} من {items.length}</span>
                        </div>
                        <div className="flex-1 px-4">
                            <div className="bg-white rounded-2xl shadow-xl p-8 border border-gray-100 text-center relative mt-4">
                                <div className="absolute top-4 left-4 text-xs text-gray-300 font-mono">#{currentItem.code}</div>
                                <span className="inline-block px-3 py-1 bg-gray-100 rounded-full text-xs text-gray-500 mb-4">{currentItem.brand || 'عام'}</span>
                                <h2 className="text-3xl font-bold text-gray-800 mb-2">كم يوجد؟</h2>
                                <h3 className="text-2xl text-primary font-bold mb-6">{currentItem.name}</h3>
                                <div className="relative mb-6">
                                    <input type="number" value={currentEntry.quantity ?? ''} 
                                        onChange={(e) => {
                                            const val = e.target.value === '' ? null : parseFloat(e.target.value);
                                            setLocalEntries(p => ({...p, [currentItem.id]: { itemId: currentItem.id, quantity: val }}));
                                            setWarningMessage(null);
                                        }}
                                        className="w-full text-center text-5xl font-bold border-b-2 border-gray-300 focus:border-primary focus:outline-none py-4 bg-transparent" placeholder="0" autoFocus />
                                    <span className="absolute left-0 bottom-6 text-gray-400 font-medium">{currentItem.unit}</span>
                                </div>
                                {warningMessage && (
                                    <div className="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg animate-pulse">
                                        <p className="text-sm text-amber-800 font-bold mb-2">{warningMessage}</p>
                                        <button onClick={() => { setWarningMessage(null); handleNext(); }} className="text-xs bg-amber-500 text-white px-4 py-2 rounded">تأكيد ومتابعة</button>
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t z-10 max-w-md mx-auto grid grid-cols-2 gap-4">
                            <Button variant="outline" onClick={() => setCurrentIndex(p => p - 1)} disabled={currentIndex === 0}><Icon name="ArrowRight" /> السابق</Button>
                            <Button onClick={handleNext} disabled={isChecking}>
                                {isChecking ? <Icon name="Loader2" className="spin"/> : (currentIndex === items.length - 1 ? 'مراجعة' : 'التالي')}
                                {!isChecking && currentIndex < items.length - 1 && <Icon name="ArrowLeft" />}
                            </Button>
                        </div>
                    </div>
                );
            }

            // List Mode View
            const filledCount = Object.values(localEntries).filter(e => e.quantity !== null).length;
            const isComplete = filledCount === items.length;

            return (
                <div className="max-w-2xl mx-auto min-h-screen bg-gray-50 pb-40">
                    <div className="p-4 flex justify-between bg-white shadow-sm sticky top-0 z-10">
                        <h1 className="font-bold">مراجعة ({filledCount}/{items.length})</h1>
                        <Button variant="outline" onClick={() => setViewMode('focus')} className="text-xs px-2 py-1">وضع السؤال</Button>
                    </div>
                    <div className="p-4 space-y-2">
                        {items.map(item => {
                            const qty = localEntries[item.id]?.quantity;
                            const hasVal = qty !== null && qty !== undefined;
                            return (
                                <div key={item.id} className={`p-4 rounded-lg flex justify-between items-center ${hasVal ? 'bg-white shadow-sm' : 'bg-red-50 border border-red-100'}`}>
                                    <div>
                                        <div className="text-xs text-gray-400 font-mono">{item.code}</div>
                                        <div className="font-bold">{item.name}</div>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <span className={`text-lg font-bold ${hasVal ? 'text-primary' : 'text-red-400'}`}>{hasVal ? qty : '--'}</span>
                                        <button onClick={() => { setCurrentIndex(items.indexOf(item)); setViewMode('focus'); }} className="text-gray-400">✏️</button>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t z-20 max-w-2xl mx-auto flex flex-col gap-2">
                        <Button variant={isComplete ? "primary" : "secondary"} fullWidth onClick={() => setShowSubmitConfirm(true)} disabled={isSaving} className={isComplete ? 'animate-pulse' : ''}>
                             {isSaving ? <Icon name="Loader2" className="spin"/> : <><Icon name="Send"/> إرسال للإدارة</>}
                        </Button>
                        <Button variant="outline" fullWidth onClick={handleSaveDraft}>{saveStatus === 'saved' ? 'تم الحفظ' : 'حفظ مسودة'}</Button>
                        <Button variant="outline" fullWidth onClick={onExit} className="text-gray-400 border-gray-200">خروج</Button>
                    </div>
                    {showSubmitConfirm && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl p-6 w-full max-w-sm text-center animate-in zoom-in-95">
                                <h3 className="font-bold mb-2">تأكيد الإرسال</h3>
                                <p className="text-gray-500 mb-4">{!isComplete && <span className="text-red-500 block">الجرد غير مكتمل!</span>} هل أنت متأكد؟</p>
                                <div className="flex gap-2">
                                    <Button fullWidth onClick={confirmSubmit} className="bg-primary hover:bg-teal-700">نعم</Button>
                                    <Button fullWidth variant="outline" onClick={() => setShowSubmitConfirm(false)}>لا</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const AdminDashboard = ({ sites, sessions, templateItems, onCreateSite, onRenameSite, onDeleteSite, onCreateSession, onApproveSession, onUnapproveSession, onRequestModification, onAddTemplateItem, onDeleteTemplateItem, onUpdateSessionItems, onLogout }) => {
            const [showTemplateManager, setShowTemplateManager] = useState(false);
            const [sessionToManageItems, setSessionToManageItems] = useState(null);
            const [selectedSiteId, setSelectedSiteId] = useState(null);
            const [modal, setModal] = useState(null); // { type: 'createSite' | 'createSession' | 'view', data: any }
            
            // Temporary form states
            const [tempName, setTempName] = useState('');
            const [tempDates, setTempDates] = useState({ start: '', end: '' });
            const [newItem, setNewItem] = useState({ name: '', code: '', brand: '', unit: 'كجم', min: '', max: '' });

            const handleExport = (session) => {
                const data = session.items.map((item, idx) => ({
                    "م": idx + 1, "الكود": item.code, "المادة": item.name, "العلامة": item.brand, "الوحدة": item.unit, 
                    "الكمية": session.entries[item.id]?.quantity ?? 0
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Inventory");
                XLSX.writeFile(wb, `Inventory_${session.siteName}.xlsx`);
            };

            const handleAddItem = (e, isTemplate) => {
                e.preventDefault();
                if(!newItem.name || !newItem.code) return;
                const item = { 
                    id: Math.random().toString(36).substr(2, 9), 
                    ...newItem, 
                    minQuantity: newItem.min ? Number(newItem.min) : undefined, 
                    maxQuantity: newItem.max ? Number(newItem.max) : undefined 
                };
                if(isTemplate) onAddTemplateItem(item);
                else {
                    const updated = [...sessionToManageItems.items, item].sort((a,b) => a.code.localeCompare(b.code, undefined, {numeric: true}));
                    onUpdateSessionItems(sessionToManageItems.id, updated);
                    setSessionToManageItems({...sessionToManageItems, items: updated});
                }
                setNewItem({ name: '', code: '', brand: '', unit: 'كجم', min: '', max: '' });
            };

            const selectedSite = sites.find(s => s.id === selectedSiteId);
            const siteSessions = sessions.filter(s => s.siteId === selectedSiteId);

            return (
                <div className="min-h-screen bg-gray-50 p-6" dir="rtl">
                    <div className="max-w-6xl mx-auto">
                        <header className="flex justify-between items-center mb-10">
                            <div className="flex items-center gap-3">
                                {selectedSiteId && <button onClick={() => setSelectedSiteId(null)} className="p-2 bg-white rounded-full shadow-sm"><Icon name="ArrowRight"/></button>}
                                <h1 className="text-3xl font-bold">{selectedSite ? selectedSite.name : 'لوحة تحكم الإدارة'}</h1>
                            </div>
                            <div className="flex gap-2">
                                <Button variant="outline" onClick={() => setShowTemplateManager(!showTemplateManager)}><Icon name="Settings"/> {showTemplateManager ? 'إخفاء' : 'القالب'}</Button>
                                {!selectedSiteId ? 
                                    <Button onClick={() => setModal({type:'createSite'})}><Icon name="Building2"/> إضافة موقع</Button> :
                                    <Button onClick={() => { setTempDates({start: new Date().toISOString().split('T')[0], end: ''}); setModal({type:'createSession'}); }}><Icon name="RefreshCcw"/> جرد جديد</Button>
                                }
                                <Button variant="outline" onClick={onLogout} className="text-red-500 border-red-200">خروج</Button>
                            </div>
                        </header>

                        {/* Modals */}
                        {modal?.type === 'createSite' && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                                <div className="bg-white rounded-xl p-6 w-full max-w-sm animate-in zoom-in-95">
                                    <h3 className="font-bold mb-4">موقع جديد</h3>
                                    <input className="w-full border p-2 rounded mb-4" placeholder="اسم الموقع" autoFocus onChange={e => setTempName(e.target.value)} />
                                    <Button fullWidth onClick={() => { if(tempName) onCreateSite(tempName); setModal(null); setTempName(''); }}>حفظ</Button>
                                </div>
                            </div>
                        )}
                        {modal?.type === 'createSession' && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                                <div className="bg-white rounded-xl p-6 w-full max-w-sm animate-in zoom-in-95">
                                    <h3 className="font-bold mb-4">جرد جديد</h3>
                                    <div className="flex gap-2 mb-4">
                                        <input type="date" className="border p-2 rounded w-full" value={tempDates.start} onChange={e => setTempDates({...tempDates, start: e.target.value})}/>
                                        <input type="date" className="border p-2 rounded w-full" value={tempDates.end} onChange={e => setTempDates({...tempDates, end: e.target.value})}/>
                                    </div>
                                    <Button fullWidth onClick={() => { if(tempDates.start && tempDates.end) onCreateSession(selectedSiteId, tempDates.start, tempDates.end); setModal(null); }}>إنشاء</Button>
                                </div>
                            </div>
                        )}
                         {modal?.type === 'view' && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col animate-in zoom-in-95">
                                    <div className="p-4 border-b flex justify-between"><h2 className="font-bold">التفاصيل</h2><button onClick={() => setModal(null)}><Icon name="X"/></button></div>
                                    <div className="p-4 overflow-y-auto flex-1">
                                        <table className="w-full text-right">
                                            <thead className="bg-gray-50"><tr><th className="p-2">مادة</th><th className="p-2">كمية</th><th className="p-2">وحدة</th></tr></thead>
                                            <tbody>{modal.data.items.map(i => <tr key={i.id} className="border-b"><td className="p-2">{i.name}</td><td className="p-2 font-bold text-primary">{modal.data.entries[i.id]?.quantity ?? '--'}</td><td className="p-2 text-gray-500">{i.unit}</td></tr>)}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Template Manager */}
                        {showTemplateManager && (
                            <div className="bg-white p-6 rounded-xl shadow mb-8 border">
                                <h3 className="font-bold mb-4 border-b pb-2">القالب العام</h3>
                                <form onSubmit={(e) => handleAddItem(e, true)} className="grid grid-cols-2 md:grid-cols-5 gap-2 mb-4 bg-gray-50 p-2 rounded">
                                    <input placeholder="الاسم" className="border p-2 rounded" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} required/>
                                    <input placeholder="كود" className="border p-2 rounded" value={newItem.code} onChange={e => setNewItem({...newItem, code: e.target.value})} required/>
                                    <input placeholder="وحدة" className="border p-2 rounded" value={newItem.unit} onChange={e => setNewItem({...newItem, unit: e.target.value})} required/>
                                    <input placeholder="Min" type="number" className="border p-2 rounded" value={newItem.min} onChange={e => setNewItem({...newItem, min: e.target.value})}/>
                                    <Button type="submit"><Icon name="Plus"/> إضافة</Button>
                                </form>
                                <div className="max-h-60 overflow-auto">
                                    <table className="w-full text-right text-sm">
                                        <thead className="bg-gray-100"><tr><th className="p-2">كود</th><th className="p-2">اسم</th><th className="p-2">حذف</th></tr></thead>
                                        <tbody>{templateItems.map(i => <tr key={i.id} className="border-b"><td className="p-2 font-mono">{i.code}</td><td className="p-2">{i.name}</td><td className="p-2"><button onClick={() => onDeleteTemplateItem(i.id)} className="text-red-500"><Icon name="Trash2" size={16}/></button></td></tr>)}</tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* Session Item Manager */}
                        {sessionToManageItems && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                                <div className="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col animate-in zoom-in-95">
                                    <div className="p-4 border-b flex justify-between"><h2 className="font-bold">إدارة مواد الجرد</h2><button onClick={() => setSessionToManageItems(null)}><Icon name="X"/></button></div>
                                    <div className="p-4 overflow-y-auto flex-1">
                                        <form onSubmit={(e) => handleAddItem(e, false)} className="bg-blue-50 p-4 rounded mb-4 grid grid-cols-2 md:grid-cols-4 gap-2">
                                            <input placeholder="الاسم" className="border p-2 rounded" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} required/>
                                            <input placeholder="كود" className="border p-2 rounded" value={newItem.code} onChange={e => setNewItem({...newItem, code: e.target.value})} required/>
                                            <input placeholder="وحدة" className="border p-2 rounded" value={newItem.unit} onChange={e => setNewItem({...newItem, unit: e.target.value})} required/>
                                            <Button type="submit"><Icon name="Plus"/> إضافة</Button>
                                        </form>
                                        <table className="w-full text-right text-sm">
                                            <thead className="bg-gray-100"><tr><th className="p-2">كود</th><th className="p-2">اسم</th><th className="p-2">حذف</th></tr></thead>
                                            <tbody>{sessionToManageItems.items.map(i => <tr key={i.id} className="border-b"><td className="p-2 font-mono">{i.code}</td><td className="p-2">{i.name}</td><td className="p-2"><button onClick={() => {
                                                const updated = sessionToManageItems.items.filter(x => x.id !== i.id);
                                                onUpdateSessionItems(sessionToManageItems.id, updated);
                                                setSessionToManageItems({...sessionToManageItems, items: updated});
                                            }} className="text-red-500"><Icon name="Trash2" size={16}/></button></td></tr>)}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Content */}
                        {!selectedSiteId ? (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {sites.map(s => (
                                    <div key={s.id} className="bg-white p-6 rounded-xl shadow-sm border hover:border-primary group">
                                        <div className="flex justify-between mb-4">
                                            <div className="bg-gray-100 p-3 rounded group-hover:text-primary"><Icon name="Building2" size={24}/></div>
                                            <div className="flex gap-2">
                                                <button onClick={() => {const n = prompt('الاسم الجديد', s.name); if(n) onRenameSite(s.id, n);}} className="text-gray-300 hover:text-blue-500"><Icon name="Edit2" size={16}/></button>
                                                <button onClick={() => {if(confirm('حذف؟')) onDeleteSite(s.id);}} className="text-gray-300 hover:text-red-500"><Icon name="Trash2" size={16}/></button>
                                            </div>
                                        </div>
                                        <h3 className="font-bold text-xl">{s.name}</h3>
                                        <button onClick={() => setSelectedSiteId(s.id)} className="text-primary font-bold mt-4 flex items-center gap-1">التفاصيل <Icon name="ArrowRight" className="rtl:rotate-180" size={16}/></button>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="bg-white rounded-xl shadow overflow-hidden">
                                <table className="w-full text-right">
                                    <thead className="bg-gray-50 border-b"><tr><th className="p-4">الفترة</th><th className="p-4">الحالة</th><th className="p-4">الإجراءات</th></tr></thead>
                                    <tbody className="divide-y">
                                        {siteSessions.map(s => (
                                            <tr key={s.id} className="hover:bg-gray-50">
                                                <td className="p-4 font-bold text-gray-700" dir="ltr">{s.startDate} / {s.endDate}</td>
                                                <td className="p-4">
                                                    {s.status === 'active' && <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">جاري التعبئة</span>}
                                                    {s.status === 'submitted' && <span className="bg-amber-100 text-amber-800 text-xs px-2 py-1 rounded">انتظار اعتماد</span>}
                                                    {s.status === 'approved' && <span className="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">معتمد</span>}
                                                </td>
                                                <td className="p-4 flex flex-wrap gap-2">
                                                    <Button variant="outline" className="text-xs h-8 px-2" onClick={() => setModal({type:'view', data: s})}><Icon name="Eye" size={14}/> عرض</Button>
                                                    <Button variant="outline" className="text-xs h-8 px-2 text-blue-600 border-blue-200" onClick={() => setSessionToManageItems(s)}><Icon name="Box" size={14}/> المواد</Button>
                                                    {s.status === 'submitted' && <><Button className="text-xs h-8 px-2 bg-green-600" onClick={() => onApproveSession(s.id)}><Icon name="Lock" size={14}/> اعتماد</Button><Button variant="outline" className="text-xs h-8 px-2 text-amber-600" onClick={() => onRequestModification(s.id)}><Icon name="FileEdit" size={14}/> تعديل</Button></>}
                                                    {s.status === 'approved' && <><Button variant="outline" className="text-xs h-8 px-2" onClick={() => onUnapproveSession(s.id)}><Icon name="Unlock" size={14}/></Button><Button variant="outline" className="text-xs h-8 px-2 text-green-600 border-green-200" onClick={() => handleExport(s)}><Icon name="FileSpreadsheet" size={14}/> اكسل</Button></>}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const INITIAL_ITEMS = [
            { id: '1', code: '101', brand: 'المهيدب', name: 'أرز بسمتي', unit: 'كجم', minQuantity: 10, maxQuantity: 100 },
            { id: '2', code: '102', brand: 'الأسرة', name: 'سكر ناعم', unit: 'كجم', minQuantity: 5, maxQuantity: 50 },
            { id: '4', code: '201', brand: 'المراعي', name: 'حليب طويل الأجل', unit: 'كرتون', minQuantity: 20, maxQuantity: 200 },
        ];

        const App = () => {
            const [role, setRole] = useState(null);
            const [sites, setSites] = useState(() => JSON.parse(safeStorage.getItem('jarda_sites')) || []);
            const [sessions, setSessions] = useState(() => JSON.parse(safeStorage.getItem('jarda_sessions')) || []);
            const [tplItems, setTplItems] = useState(() => JSON.parse(safeStorage.getItem('jarda_items')) || INITIAL_ITEMS);
            const [supSiteId, setSupSiteId] = useState(null);
            const [supSessId, setSupSessId] = useState(null);

            useEffect(() => safeStorage.setItem('jarda_sites', JSON.stringify(sites)), [sites]);
            useEffect(() => safeStorage.setItem('jarda_sessions', JSON.stringify(sessions)), [sessions]);
            useEffect(() => safeStorage.setItem('jarda_items', JSON.stringify(tplItems)), [tplItems]);

            useEffect(() => {
                const sync = (e) => {
                    if (e.key === 'jarda_sessions') setSessions(JSON.parse(e.newValue));
                    if (e.key === 'jarda_sites') setSites(JSON.parse(e.newValue));
                    if (e.key === 'jarda_items') setTplItems(JSON.parse(e.newValue));
                };
                window.addEventListener('storage', sync);
                return () => window.removeEventListener('storage', sync);
            }, []);

            const sortItems = (arr) => [...arr].sort((a,b) => a.code.localeCompare(b.code, undefined, {numeric: true}));

            if(!role) return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
                        <div className="bg-primary/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6"><Icon name="LayoutDashboard" className="text-primary" size={32}/></div>
                        <h1 className="text-2xl font-bold mb-8">منصة جرد الإعاشة</h1>
                        <button onClick={() => setRole('admin')} className="w-full p-4 mb-4 border bg-gray-50 rounded-xl flex items-center gap-4 hover:border-primary"><Icon name="LayoutDashboard" className="text-blue-600"/> <b>مدير النظام</b></button>
                        <button onClick={() => setRole('supervisor')} className="w-full p-4 border bg-gray-50 rounded-xl flex items-center gap-4 hover:border-secondary"><Icon name="Users" className="text-amber-600"/> <b>مشرف ميداني</b></button>
                    </div>
                </div>
            );

            if(role === 'admin') return <AdminDashboard sites={sites} sessions={sessions} templateItems={tplItems} 
                onCreateSite={(name) => setSites(p => [...p, {id: Math.random().toString(36).substr(2,9), name}])}
                onRenameSite={(id, name) => { setSites(p => p.map(s => s.id === id ? {...s, name} : s)); setSessions(p => p.map(s => s.siteId === id ? {...s, siteName: name} : s)); }}
                onDeleteSite={(id) => setSites(p => p.filter(s => s.id !== id))}
                onCreateSession={(sid, start, end) => {
                    const site = sites.find(s => s.id === sid);
                    const lastSess = sessions.filter(s => s.siteId === sid).sort((a,b) => b.startDate.localeCompare(a.startDate))[0];
                    setSessions(p => [{id: Math.random().toString(36).substr(2,9), siteId: sid, siteName: site.name, startDate: start, endDate: end, status: 'active', entries: {}, items: sortItems([...(lastSess?.items || tplItems)])}, ...p]);
                }}
                onApproveSession={(id) => setSessions(p => p.map(s => s.id === id ? {...s, status: 'approved'} : s))}
                onUnapproveSession={(id) => setSessions(p => p.map(s => s.id === id ? {...s, status: 'submitted'} : s))}
                onRequestModification={(id) => setSessions(p => p.map(s => s.id === id ? {...s, status: 'active'} : s))}
                onAddTemplateItem={(i) => setTplItems(p => sortItems([...p, i]))}
                onDeleteTemplateItem={(id) => setTplItems(p => p.filter(i => i.id !== id))}
                onUpdateSessionItems={(sid, items) => setSessions(p => p.map(s => s.id === sid ? {...s, items: sortItems(items)} : s))}
                onLogout={() => setRole(null)}
            />;

            if(role === 'supervisor') {
                if(supSessId) {
                    const sess = sessions.find(s => s.id === supSessId);
                    if(!sess) return null;
                    if(sess.status === 'approved') return <div className="h-screen flex flex-col items-center justify-center"><Icon name="CheckCircle" className="text-green-500 mb-4" size={64}/><h2>تم الاعتماد</h2><Button onClick={() => setSupSessId(null)}>عودة</Button></div>;
                    if(sess.status === 'submitted') return <div className="h-screen flex flex-col items-center justify-center"><h2 className="text-4xl mb-4">⏳</h2><h2>بانتظار المراجعة</h2><Button onClick={() => setSupSessId(null)}>عودة</Button></div>;
                    return <SupervisorDashboard session={sess} items={sess.items} onUpdateSession={(u) => setSessions(p => p.map(s => s.id === u.id ? u : s))} onExit={() => setSupSessId(null)}/>;
                }
                if(supSiteId) {
                    const activeSess = sessions.filter(s => s.siteId === supSiteId && s.status !== 'approved');
                    return (
                        <div className="p-6 bg-gray-50 min-h-screen">
                            <div className="max-w-md mx-auto">
                                <Button variant="outline" onClick={() => setSupSiteId(null)} className="mb-6"><Icon name="ArrowRight"/> تغيير الموقع</Button>
                                {activeSess.length === 0 ? <p className="text-center text-gray-400">لا يوجد جرد مفتوح</p> : activeSess.map(s => (
                                    <div key={s.id} onClick={() => setSupSessId(s.id)} className="bg-white p-4 rounded-xl shadow-sm border mb-3 cursor-pointer hover:border-primary flex justify-between items-center">
                                        <div><div className="flex gap-2 font-bold"><Icon name="Calendar" size={14}/><span dir="ltr">{s.startDate}</span></div></div>
                                        <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">{s.status === 'active' ? 'مفتوح' : 'مراجعة'}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    );
                }
                return (
                    <div className="p-6 bg-gray-50 min-h-screen">
                        <div className="max-w-md mx-auto">
                            <h1 className="text-2xl font-bold mb-8">اختر الموقع</h1>
                            <Button variant="outline" onClick={() => setRole(null)} className="mb-4">خروج</Button>
                            {sites.map(s => <button key={s.id} onClick={() => setSupSiteId(s.id)} className="w-full bg-white p-5 rounded-xl shadow-sm border mb-3 flex gap-4 text-right font-bold"><Icon name="Building2" className="text-gray-400"/> {s.name}</button>)}
                        </div>
                    </div>
                );
            }
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>