<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>نظام جرد الإعاشة الذكي | Jarda</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (To compile JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- XLSX (Excel Export) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Tajawal', 'sans-serif'] },
            colors: {
              primary: '#0f766e',
              secondary: '#f59e0b',
            },
            screens: {
              'xs': '375px',
            }
          }
        }
      }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
      /* Base Styles */
      body { background-color: #f9fafb; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
      
      /* Scrollbar Styling */
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
      
      /* Animations */
      .animate-in { animation-duration: 0.2s; animation-fill-mode: both; }
      .fade-in { animation-name: fadeIn; }
      .zoom-in-95 { animation-name: zoomIn95; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes zoomIn95 { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
      .spin { animation: spin 1s linear infinite; }
      @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

      /* Mobile Inputs Cleanup */
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
      input[type=number] { -moz-appearance: textfield; }
      
      /* Prevent Text Selection on UI elements for app-like feel */
      .no-select { user-select: none; -webkit-user-select: none; }
      
      /* Dynamic Viewport Height utility */
      .min-h-dvh { min-height: 100vh; min-height: 100dvh; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
    "xlsx": "https://aistudiocdn.com/xlsx@^0.18.5"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useRef } = React;

        // --- ICONS (Lucide Alternatives) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                LayoutDashboard: <path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/>,
                Users: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
                Building2: <><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></>,
                ArrowRight: <><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></>,
                ArrowLeft: <><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></>,
                Plus: <><path d="M12 5v14"/><path d="M5 12h14"/></>,
                Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
                Edit2: <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>,
                RefreshCcw: <><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></>,
                Settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
                X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
                Eye: <><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>,
                Box: <><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></>,
                Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
                Unlock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></>,
                FileEdit: <><path d="M4 13.5V4a2 2 0 0 1 2-2h8.5L20 7.5V20a2 2 0 0 1-2 2h-5.5"/><polyline points="14 2 14 8 20 8"/><path d="M10.42 12.61a2.1 2.1 0 1 1 2.97 2.97L7.95 21 4 22l.99-3.95 5.43-5.44Z"/></>,
                FileSpreadsheet: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></>,
                Calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>,
                CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
                Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>,
                Send: <><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
                AlertTriangle: <><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></>,
                Loader2: <path d="M21 12a9 9 0 1 1-6.219-8.56"/>,
                CalendarClock: <><path d="M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/><circle cx="18" cy="18" r="4"/><path d="M18 16v2l1.5 1.5"/></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        // --- UTILS & STORAGE ---
        const safeStorage = {
            getItem: (key) => { try { return localStorage.getItem(key); } catch(e) { return null; } },
            setItem: (key, val) => { try { localStorage.setItem(key, val); } catch(e) {} }
        };

        const sortItems = (arr) => [...arr].sort((a,b) => a.code.localeCompare(b.code, undefined, {numeric: true, sensitivity: 'base'}));

        // --- API SERVICE ---
        const checkInventoryAnomaly = async (itemName, unit, quantity) => {
            // Placeholder for AI Check logic
            return { isSuspicious: false };
        };

        // --- COMPONENTS ---
        const Button = ({ children, variant = 'primary', fullWidth = false, className = '', ...props }) => {
            const variants = {
                primary: "bg-primary text-white active:bg-teal-800 shadow-sm",
                secondary: "bg-secondary text-white active:bg-amber-600 shadow-sm",
                danger: "bg-red-500 text-white active:bg-red-600",
                outline: "border-2 border-primary text-primary active:bg-teal-50"
            };
            return (
                <button className={`px-4 py-3 md:py-2 rounded-xl font-medium transition-all duration-100 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 no-select active:scale-[0.98] ${variants[variant]} ${fullWidth ? 'w-full' : ''} ${className}`} {...props}>
                    {children}
                </button>
            );
        };

        const SupervisorDashboard = ({ session, items, onUpdateSession, onExit }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [localEntries, setLocalEntries] = useState(session.entries || {});
            const [isChecking, setIsChecking] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [warningMessage, setWarningMessage] = useState(null);
            const [viewMode, setViewMode] = useState('focus');
            const [saveStatus, setSaveStatus] = useState('idle');
            const [showSubmitConfirm, setShowSubmitConfirm] = useState(false);

            useEffect(() => { setLocalEntries(session.entries || {}); }, [session]);

            const currentItem = items[currentIndex];
            if (!currentItem) return null;
            if (items.length === 0) return <div className="p-8 text-center">لا يوجد مواد.<Button onClick={onExit} className="mt-4">خروج</Button></div>;

            const currentEntry = localEntries[currentItem.id] || { itemId: currentItem.id, quantity: null };

            const handleNext = async () => {
                const qty = currentEntry.quantity;
                if (qty !== null && qty !== undefined && !warningMessage) {
                    let isSuspicious = false;
                    let message = '';
                    
                    const min = currentItem.minQuantity;
                    const max = currentItem.maxQuantity;

                    if ((min !== undefined && qty < min) || (max !== undefined && qty > max)) {
                        isSuspicious = true;
                        if (min !== undefined && max !== undefined) {
                             message = `الرقم خارج النطاق (${min} - ${max}). هل انت متأكد من صحة الرقم؟`;
                        } else if (min !== undefined) {
                             message = `الرقم أقل من الحد الأدنى (${min}). هل انت متأكد من صحة الرقم؟`;
                        } else {
                             message = `الرقم أعلى من الحد الأعلى (${max}). هل انت متأكد من صحة الرقم؟`;
                        }
                    } else if (qty > 50 && !max) { 
                         // Simplified check
                    }
                    
                    if (isSuspicious) { setWarningMessage(message); return; }
                }
                setWarningMessage(null);
                if (currentIndex < items.length - 1) setCurrentIndex(prev => prev + 1);
                else setViewMode('list');
            };

            const handleSaveDraft = () => {
                setIsSaving(true);
                setTimeout(() => {
                    onUpdateSession({ ...session, entries: localEntries, status: 'active' });
                    setIsSaving(false);
                    setSaveStatus('saved');
                    setTimeout(() => setSaveStatus('idle'), 2000);
                }, 500);
            };

            const confirmSubmit = () => {
                setShowSubmitConfirm(false);
                setIsSaving(true);
                onUpdateSession({ ...session, entries: localEntries, status: 'submitted' });
            };

            // Focus Mode
            if (viewMode === 'focus') {
                return (
                    <div className="max-w-md mx-auto flex flex-col min-h-dvh bg-gray-50 pb-20">
                        <div className="flex justify-between items-center p-4 no-select">
                            <button onClick={() => setViewMode('list')} className="text-sm text-primary font-bold px-2 py-1 bg-white rounded-md shadow-sm">قائمة</button>
                            <span className="text-gray-500 text-sm font-medium">{currentIndex + 1} / {items.length}</span>
                        </div>
                        <div className="flex-1 px-4 flex flex-col justify-center pb-20">
                            <div className="bg-white rounded-2xl shadow-lg p-6 md:p-8 border border-gray-100 text-center relative">
                                <div className="absolute top-4 left-4 text-xs text-gray-300 font-mono">#{currentItem.code}</div>
                                {currentItem.brand && (
                                    <span className="inline-block px-3 py-1 bg-gray-100 rounded-full text-xs text-gray-500 mb-4">{currentItem.brand}</span>
                                )}
                                <h2 className="text-2xl md:text-3xl font-bold text-gray-800 mb-2">كم يوجد؟</h2>
                                <h3 className="text-xl md:text-2xl text-primary font-bold mb-6 line-clamp-2">{currentItem.name}</h3>
                                <div className="relative mb-6">
                                    <input type="number" inputMode="decimal" value={currentEntry.quantity ?? ''} 
                                        onChange={(e) => {
                                            const val = e.target.value === '' ? null : parseFloat(e.target.value);
                                            setLocalEntries(p => ({...p, [currentItem.id]: { itemId: currentItem.id, quantity: val }}));
                                            setWarningMessage(null);
                                        }}
                                        className="w-full text-center text-4xl md:text-5xl font-bold border-b-2 border-gray-300 focus:border-primary focus:outline-none py-4 bg-transparent" placeholder="0" autoFocus />
                                    <span className="absolute left-0 bottom-6 text-gray-400 font-medium text-sm">{currentItem.unit}</span>
                                </div>
                                {warningMessage && (
                                    <div className="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg animate-pulse">
                                        <p className="text-sm text-amber-800 font-bold mb-2">{warningMessage}</p>
                                        <button onClick={() => { setWarningMessage(null); handleNext(); }} className="text-xs bg-amber-500 text-white px-4 py-2 rounded">تأكيد ومتابعة</button>
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t z-10 max-w-md mx-auto grid grid-cols-2 gap-3 shadow-[0_-4px_10px_rgba(0,0,0,0.05)]">
                            <Button variant="outline" onClick={() => setCurrentIndex(p => p - 1)} disabled={currentIndex === 0}><Icon name="ArrowRight" /> السابق</Button>
                            <Button onClick={handleNext} disabled={isChecking}>
                                {isChecking ? <Icon name="Loader2" className="spin"/> : (currentIndex === items.length - 1 ? 'مراجعة' : 'التالي')}
                                {!isChecking && currentIndex < items.length - 1 && <Icon name="ArrowLeft" />}
                            </Button>
                        </div>
                    </div>
                );
            }

            // List Mode
            const filledCount = Object.values(localEntries).filter(e => e.quantity !== null).length;
            const isComplete = filledCount === items.length;

            return (
                <div className="max-w-2xl mx-auto min-h-dvh bg-gray-50 flex flex-col">
                    <div className="p-4 flex justify-between items-center bg-white shadow-sm sticky top-0 z-10">
                        <h1 className="font-bold text-gray-800">مراجعة ({filledCount}/{items.length})</h1>
                        <Button variant="outline" onClick={() => setViewMode('focus')} className="text-xs h-8 px-3">وضع السؤال</Button>
                    </div>
                    <div className="p-3 space-y-3 pb-48 flex-1">
                        {items.map(item => {
                            const qty = localEntries[item.id]?.quantity;
                            const hasVal = qty !== null && qty !== undefined;
                            return (
                                <div key={item.id} className={`p-4 rounded-xl flex justify-between items-center transition-all ${hasVal ? 'bg-white shadow-sm border border-gray-100' : 'bg-red-50 border border-red-100'}`}>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex items-center gap-2">
                                            <span className="text-[10px] bg-gray-100 px-1 rounded text-gray-500 font-mono">{item.code}</span>
                                            <div className="font-bold text-gray-800 truncate">{item.name}</div>
                                        </div>
                                        <div className="text-xs text-gray-400 mt-1">{item.brand}</div>
                                    </div>
                                    <div className="flex items-center gap-3 mr-3">
                                        <div className="text-left">
                                            <span className={`text-lg font-bold block leading-none ${hasVal ? 'text-primary' : 'text-red-400'}`}>{hasVal ? qty : '--'}</span>
                                            <span className="text-[10px] text-gray-400">{item.unit}</span>
                                        </div>
                                        <button onClick={() => { setCurrentIndex(items.indexOf(item)); setViewMode('focus'); }} className="w-8 h-8 flex items-center justify-center bg-gray-50 rounded-full text-gray-400 active:bg-gray-200"><Icon name="Edit2" size={14}/></button>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t z-20 max-w-2xl mx-auto flex flex-col gap-2 shadow-[0_-4px_15px_-3px_rgba(0,0,0,0.1)]">
                        <Button variant={isComplete ? "primary" : "secondary"} fullWidth onClick={() => setShowSubmitConfirm(true)} disabled={isSaving} className={`py-4 ${isComplete ? 'animate-pulse' : ''}`}>
                             {isSaving ? <Icon name="Loader2" className="spin"/> : <><Icon name="Send"/> إرسال للإدارة</>}
                        </Button>
                        <div className="grid grid-cols-2 gap-2">
                            <Button variant="outline" fullWidth onClick={handleSaveDraft} className="text-xs">{saveStatus === 'saved' ? 'تم الحفظ' : 'حفظ مسودة'}</Button>
                            <Button variant="outline" fullWidth onClick={onExit} className="text-xs text-gray-400 border-gray-200">خروج</Button>
                        </div>
                    </div>
                    {showSubmitConfirm && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-xl p-6 w-full max-w-sm text-center animate-in zoom-in-95">
                                <h3 className="font-bold mb-2 text-lg">تأكيد الإرسال</h3>
                                <p className="text-gray-500 mb-6">{!isComplete && <span className="text-red-500 font-bold block mb-1">⚠️ الجرد غير مكتمل!</span>} هل تريد إرسال البيانات؟</p>
                                <div className="flex gap-3">
                                    <Button fullWidth onClick={confirmSubmit}>نعم</Button>
                                    <Button fullWidth variant="outline" onClick={() => setShowSubmitConfirm(false)}>لا</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const AdminDashboard = ({ 
            sites, sessions, templateItems, 
            onCreateSite, onRenameSite, onDeleteSite, 
            onCreateSession, onDeleteSession, onUpdateSessionDate, 
            onApproveSession, onUnapproveSession, onRequestModification, 
            onAddTemplateItem, onUpdateTemplateItem, onDeleteTemplateItem, 
            onUpdateSessionItems, onLogout 
        }) => {
            const [showTemplateManager, setShowTemplateManager] = useState(false);
            const [sessionToManageItems, setSessionToManageItems] = useState(null);
            const [selectedSiteId, setSelectedSiteId] = useState(null);
            const [modal, setModal] = useState(null); 
            const [tempName, setTempName] = useState('');
            const [tempDates, setTempDates] = useState({ start: '', end: '' });
            const [editingItem, setEditingItem] = useState(null);
            const [sessionToEditDate, setSessionToEditDate] = useState(null);

            const initialItemState = { name: '', code: '', brand: '', unit: '', min: '', max: '' };
            const [newItem, setNewItem] = useState(initialItemState);

            const handleExport = (session) => {
                const data = session.items.map((item, idx) => ({
                    "م": idx + 1, "الكود": item.code, "المادة": item.name, "العلامة": item.brand, "الحجم": item.unit, 
                    "الكمية": session.entries[item.id]?.quantity ?? 0
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Inventory");
                XLSX.writeFile(wb, `Inventory_${session.siteName}.xlsx`);
            };

            const handleItemSubmit = (e, isTemplate) => {
                e.preventDefault();
                if(!newItem.name || !newItem.code) return;
                
                const itemData = { 
                    id: editingItem ? editingItem.id : Math.random().toString(36).substr(2, 9), 
                    ...newItem, 
                    minQuantity: newItem.min ? Number(newItem.min) : undefined, 
                    maxQuantity: newItem.max ? Number(newItem.max) : undefined 
                };

                if(isTemplate) {
                    if (editingItem) {
                        onUpdateTemplateItem(itemData);
                    } else {
                        onAddTemplateItem(itemData);
                    }
                } else {
                    let updated;
                    if (editingItem) {
                        updated = sortItems(sessionToManageItems.items.map(i => i.id === editingItem.id ? itemData : i));
                    } else {
                        updated = sortItems([...sessionToManageItems.items, itemData]);
                    }
                    onUpdateSessionItems(sessionToManageItems.id, updated);
                    setSessionToManageItems({...sessionToManageItems, items: updated});
                }
                
                setNewItem(initialItemState);
                setEditingItem(null);
            };

            const handleEditItem = (item) => {
                setEditingItem(item);
                setNewItem({
                    name: item.name,
                    code: item.code,
                    brand: item.brand || '',
                    unit: item.unit,
                    min: item.minQuantity || '',
                    max: item.maxQuantity || ''
                });
            };

            const handleEditSessionDate = (session) => {
                setSessionToEditDate(session);
                setTempDates({ start: session.startDate, end: session.endDate });
                setModal({ type: 'editSessionDate' });
            };

            const selectedSite = sites.find(s => s.id === selectedSiteId);
            const siteSessions = sessions.filter(s => s.siteId === selectedSiteId);

            return (
                <div className="min-h-dvh bg-gray-50 p-4 md:p-6" dir="rtl">
                    <div className="max-w-6xl mx-auto">
                        <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                            <div className="flex items-center gap-3">
                                {selectedSiteId && <button onClick={() => setSelectedSiteId(null)} className="p-2 bg-white rounded-full shadow-sm text-gray-600"><Icon name="ArrowRight"/></button>}
                                <h1 className="text-2xl md:text-3xl font-bold text-gray-800 truncate">{selectedSite ? selectedSite.name : 'لوحة الإدارة'}</h1>
                            </div>
                            <div className="flex flex-wrap gap-2 w-full md:w-auto">
                                <Button variant="outline" onClick={() => setShowTemplateManager(!showTemplateManager)} className="text-xs md:text-sm flex-1 md:flex-none"><Icon name="Settings"/> {showTemplateManager ? 'إخفاء' : 'القالب'}</Button>
                                {!selectedSiteId ? 
                                    <Button onClick={() => setModal({type:'createSite'})} className="text-xs md:text-sm flex-1 md:flex-none"><Icon name="Building2"/> إضافة موقع</Button> :
                                    <Button onClick={() => { setTempDates({start: new Date().toISOString().split('T')[0], end: ''}); setModal({type:'createSession'}); }} className="text-xs md:text-sm flex-1 md:flex-none"><Icon name="RefreshCcw"/> جرد جديد</Button>
                                }
                                <Button variant="outline" onClick={onLogout} className="text-red-500 border-red-200 text-xs md:text-sm"><Icon name="X"/></Button>
                            </div>
                        </header>

                        {/* Modal Components */}
                        {(modal?.type === 'createSite' || modal?.type === 'createSession' || modal?.type === 'editSessionDate') && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                                <div className="bg-white rounded-xl p-6 w-full max-w-sm animate-in zoom-in-95 relative">
                                    <button onClick={() => setModal(null)} className="absolute left-4 top-4 text-gray-400"><Icon name="X"/></button>
                                    <h3 className="font-bold mb-4 text-lg">
                                        {modal.type === 'createSite' ? 'موقع جديد' : (modal.type === 'editSessionDate' ? 'تعديل تاريخ الجرد' : 'جرد جديد')}
                                    </h3>
                                    {modal.type === 'createSite' ? (
                                        <>
                                            <input className="w-full border p-3 rounded-lg mb-4" placeholder="اسم الموقع" autoFocus onChange={e => setTempName(e.target.value)} />
                                            <Button fullWidth onClick={() => { if(tempName) onCreateSite(tempName); setModal(null); setTempName(''); }}>حفظ</Button>
                                        </>
                                    ) : (
                                        <>
                                            <div className="flex flex-col gap-3 mb-4">
                                                <div><label className="text-xs text-gray-500">من</label><input type="date" className="border p-2 rounded-lg w-full" value={tempDates.start} onChange={e => setTempDates({...tempDates, start: e.target.value})}/></div>
                                                <div><label className="text-xs text-gray-500">إلى</label><input type="date" className="border p-2 rounded-lg w-full" value={tempDates.end} onChange={e => setTempDates({...tempDates, end: e.target.value})}/></div>
                                            </div>
                                            <Button fullWidth onClick={() => { 
                                                if(tempDates.start && tempDates.end) {
                                                    if (modal.type === 'editSessionDate') {
                                                        onUpdateSessionDate(sessionToEditDate.id, tempDates.start, tempDates.end);
                                                    } else {
                                                        onCreateSession(selectedSiteId, tempDates.start, tempDates.end);
                                                    }
                                                }
                                                setModal(null); 
                                            }}>{modal.type === 'editSessionDate' ? 'حفظ التغييرات' : 'إنشاء'}</Button>
                                        </>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {/* Session View Modal */}
                         {modal?.type === 'view' && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90dvh] flex flex-col animate-in zoom-in-95">
                                    <div className="p-4 border-b flex justify-between"><h2 className="font-bold">التفاصيل</h2><button onClick={() => setModal(null)}><Icon name="X"/></button></div>
                                    <div className="p-4 overflow-y-auto flex-1">
                                        <table className="w-full text-right text-sm md:text-base">
                                            <thead className="bg-gray-50 text-gray-500"><tr><th className="p-2">مادة</th><th className="p-2">كود</th><th className="p-2">علامة</th><th className="p-2">كمية</th><th className="p-2">الحجم</th></tr></thead>
                                            <tbody className="divide-y">{modal.data.items.map(i => <tr key={i.id}><td className="p-3">{i.name}</td><td className="p-3 font-mono text-xs">{i.code}</td><td className="p-3 text-gray-500">{i.brand}</td><td className="p-3 font-bold text-primary">{modal.data.entries[i.id]?.quantity ?? '--'}</td><td className="p-3 text-gray-500">{i.unit}</td></tr>)}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Template Manager */}
                        {showTemplateManager && (
                            <div className="bg-white p-4 md:p-6 rounded-xl shadow mb-8 border animate-in fade-in">
                                <h3 className="font-bold mb-4 border-b pb-2">القالب العام ({editingItem ? 'تعديل' : 'إضافة'})</h3>
                                <form onSubmit={(e) => handleItemSubmit(e, true)} className="bg-gray-50 p-3 rounded-lg mb-4">
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-2 mb-2">
                                        <input placeholder="الاسم" className="border p-2 rounded text-sm" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} required/>
                                        <input placeholder="كود" className="border p-2 rounded text-sm" value={newItem.code} onChange={e => setNewItem({...newItem, code: e.target.value})} required/>
                                        <input placeholder="العلامة" className="border p-2 rounded text-sm" value={newItem.brand} onChange={e => setNewItem({...newItem, brand: e.target.value})}/>
                                    </div>
                                    <div className="grid grid-cols-3 md:grid-cols-4 gap-2">
                                        <input placeholder="الحجم" className="border p-2 rounded text-sm" value={newItem.unit} onChange={e => setNewItem({...newItem, unit: e.target.value})} required/>
                                        <input placeholder="أدنى" type="number" className="border p-2 rounded text-sm" value={newItem.min} onChange={e => setNewItem({...newItem, min: e.target.value})}/>
                                        <input placeholder="أعلى" type="number" className="border p-2 rounded text-sm" value={newItem.max} onChange={e => setNewItem({...newItem, max: e.target.value})}/>
                                        <div className="flex gap-1">
                                            <Button type="submit" className="flex-1 text-sm py-1">{editingItem ? <Icon name="Save" size={16}/> : <Icon name="Plus" size={16}/>}</Button>
                                            {editingItem && <Button type="button" variant="outline" onClick={() => { setEditingItem(null); setNewItem(initialItemState); }} className="px-2"><Icon name="X" size={16}/></Button>}
                                        </div>
                                    </div>
                                </form>
                                <div className="max-h-60 overflow-auto border rounded-lg">
                                    <table className="w-full text-right text-sm">
                                        <thead className="bg-gray-100 sticky top-0"><tr><th className="p-2">كود</th><th className="p-2">اسم</th><th className="p-2">العلامة</th><th className="p-2">الحجم</th><th className="p-2">المدى</th><th className="p-2">إجراء</th></tr></thead>
                                        <tbody className="divide-y">{templateItems.map(i => <tr key={i.id}><td className="p-2 font-mono text-gray-500">{i.code}</td><td className="p-2">{i.name}</td><td className="p-2 text-gray-500">{i.brand}</td><td className="p-2 text-gray-500">{i.unit}</td><td className="p-2 text-xs" dir="ltr">{i.minQuantity||'-'} / {i.maxQuantity||'-'}</td><td className="p-2 flex gap-1"><button onClick={() => handleEditItem(i)} className="text-blue-500"><Icon name="Edit2" size={16}/></button><button onClick={() => onDeleteTemplateItem(i.id)} className="text-red-500"><Icon name="Trash2" size={16}/></button></td></tr>)}</tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* Session Item Manager */}
                        {sessionToManageItems && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                                <div className="bg-white rounded-xl w-full max-w-4xl max-h-[90dvh] flex flex-col animate-in zoom-in-95">
                                    <div className="p-4 border-b flex justify-between"><h2 className="font-bold">إدارة مواد الجرد ({editingItem ? 'تعديل' : 'إضافة'})</h2><button onClick={() => { setSessionToManageItems(null); setEditingItem(null); setNewItem(initialItemState); }}><Icon name="X"/></button></div>
                                    <div className="p-4 overflow-y-auto flex-1">
                                        <form onSubmit={(e) => handleItemSubmit(e, false)} className="bg-blue-50 p-3 rounded mb-4">
                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-2 mb-2">
                                                <input placeholder="الاسم" className="border p-2 rounded text-sm" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} required/>
                                                <input placeholder="كود" className="border p-2 rounded text-sm" value={newItem.code} onChange={e => setNewItem({...newItem, code: e.target.value})} required/>
                                                <input placeholder="العلامة" className="border p-2 rounded text-sm" value={newItem.brand} onChange={e => setNewItem({...newItem, brand: e.target.value})}/>
                                            </div>
                                            <div className="grid grid-cols-3 md:grid-cols-4 gap-2">
                                                <input placeholder="الحجم" className="border p-2 rounded text-sm" value={newItem.unit} onChange={e => setNewItem({...newItem, unit: e.target.value})} required/>
                                                <input placeholder="أدنى" type="number" className="border p-2 rounded text-sm" value={newItem.min} onChange={e => setNewItem({...newItem, min: e.target.value})}/>
                                                <input placeholder="أعلى" type="number" className="border p-2 rounded text-sm" value={newItem.max} onChange={e => setNewItem({...newItem, max: e.target.value})}/>
                                                <div className="flex gap-1">
                                                    <Button type="submit" className="flex-1 text-sm py-1">{editingItem ? <Icon name="Save" size={16}/> : <Icon name="Plus" size={16}/>}</Button>
                                                    {editingItem && <Button type="button" variant="outline" onClick={() => { setEditingItem(null); setNewItem(initialItemState); }} className="px-2"><Icon name="X" size={16}/></Button>}
                                                </div>
                                            </div>
                                        </form>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-right text-sm min-w-[500px]">
                                                <thead className="bg-gray-100"><tr><th className="p-2">كود</th><th className="p-2">اسم</th><th className="p-2">العلامة</th><th className="p-2">الحجم</th><th className="p-2">المدى</th><th className="p-2">إجراء</th></tr></thead>
                                                <tbody className="divide-y">{sessionToManageItems.items.map(i => <tr key={i.id}><td className="p-2 font-mono">{i.code}</td><td className="p-2">{i.name}</td><td className="p-2 text-gray-500">{i.brand}</td><td className="p-2 text-gray-500">{i.unit}</td><td className="p-2 text-xs" dir="ltr">{i.minQuantity||'-'} / {i.maxQuantity||'-'}</td><td className="p-2 flex gap-1"><button onClick={() => handleEditItem(i)} className="text-blue-500"><Icon name="Edit2" size={16}/></button><button onClick={() => {
                                                    const updated = sessionToManageItems.items.filter(x => x.id !== i.id);
                                                    onUpdateSessionItems(sessionToManageItems.id, updated);
                                                    setSessionToManageItems({...sessionToManageItems, items: updated});
                                                }} className="text-red-500"><Icon name="Trash2" size={16}/></button></td></tr>)}</tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Sites List */}
                        {!selectedSiteId ? (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {sites.map(s => (
                                    <div key={s.id} className="bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:border-primary group transition-all">
                                        <div className="flex justify-between mb-4">
                                            <div className="bg-gray-100 p-3 rounded-lg group-hover:bg-teal-50 group-hover:text-primary transition-colors"><Icon name="Building2" size={24}/></div>
                                            <div className="flex gap-2">
                                                <button onClick={() => {const n = prompt('الاسم الجديد', s.name); if(n) onRenameSite(s.id, n);}} className="text-gray-300 hover:text-blue-500 p-1"><Icon name="Edit2" size={16}/></button>
                                                <button onClick={() => {if(confirm('حذف؟')) onDeleteSite(s.id);}} className="text-gray-300 hover:text-red-500 p-1"><Icon name="Trash2" size={16}/></button>
                                            </div>
                                        </div>
                                        <h3 className="font-bold text-lg text-gray-800">{s.name}</h3>
                                        <button onClick={() => setSelectedSiteId(s.id)} className="text-primary text-sm font-bold mt-4 flex items-center gap-1">عرض الجرودات <Icon name="ArrowRight" className="rtl:rotate-180" size={14}/></button>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {/* Desktop Table */}
                                <div className="hidden md:block bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                    <table className="w-full text-right">
                                        <thead className="bg-gray-50 border-b"><tr><th className="p-4 text-sm font-medium text-gray-500">الفترة</th><th className="p-4 text-sm font-medium text-gray-500">الحالة</th><th className="p-4 text-sm font-medium text-gray-500">الإجراءات</th></tr></thead>
                                        <tbody className="divide-y border-gray-100">
                                            {siteSessions.map(s => (
                                                <tr key={s.id} className="hover:bg-gray-50">
                                                    <td className="p-4 font-bold text-gray-700 text-sm flex items-center gap-2">
                                                        <span dir="ltr">{s.startDate} / {s.endDate}</span>
                                                        <button onClick={() => handleEditSessionDate(s)} className="text-gray-400 hover:text-blue-500"><Icon name="CalendarClock" size={14}/></button>
                                                    </td>
                                                    <td className="p-4">
                                                        {s.status === 'active' && <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">جاري التعبئة</span>}
                                                        {s.status === 'submitted' && <span className="bg-amber-100 text-amber-800 text-xs px-2 py-1 rounded-full">انتظار اعتماد</span>}
                                                        {s.status === 'approved' && <span className="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">معتمد</span>}
                                                    </td>
                                                    <td className="p-4 flex flex-wrap gap-2 items-center">
                                                        <Button variant="outline" className="text-xs h-8 px-2" onClick={() => setModal({type:'view', data: s})}><Icon name="Eye" size={14}/> عرض</Button>
                                                        <Button variant="outline" className="text-xs h-8 px-2 text-blue-600 border-blue-200" onClick={() => setSessionToManageItems(s)}><Icon name="Box" size={14}/> المواد</Button>
                                                        {s.status === 'submitted' && <><Button className="text-xs h-8 px-2 bg-green-600" onClick={() => onApproveSession(s.id)}><Icon name="Lock" size={14}/> اعتماد</Button><Button variant="outline" className="text-xs h-8 px-2 text-amber-600 border-amber-200" onClick={() => onRequestModification(s.id)}><Icon name="FileEdit" size={14}/></Button></>}
                                                        {s.status === 'approved' && <><Button variant="outline" className="text-xs h-8 px-2" onClick={() => onUnapproveSession(s.id)}><Icon name="Unlock" size={14}/></Button><Button variant="outline" className="text-xs h-8 px-2 text-green-600 border-green-200" onClick={() => handleExport(s)}><Icon name="FileSpreadsheet" size={14}/> اكسل</Button></>}
                                                        <button onClick={() => { if(confirm('هل أنت متأكد من حذف هذا الجرد؟')) onDeleteSession(s.id); }} className="text-gray-300 hover:text-red-500 p-1 mr-2"><Icon name="Trash2" size={16}/></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                {/* Mobile Cards List */}
                                <div className="md:hidden space-y-3">
                                    {siteSessions.map(s => (
                                        <div key={s.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="font-bold text-gray-800 flex items-center gap-2">
                                                    <Icon name="Calendar" size={14}/>
                                                    <span dir="ltr" className="text-sm">{s.startDate}</span>
                                                    <button onClick={() => handleEditSessionDate(s)} className="text-blue-400"><Icon name="Edit2" size={12}/></button>
                                                </div>
                                                <button onClick={() => { if(confirm('حذف؟')) onDeleteSession(s.id); }} className="text-red-300 hover:text-red-500"><Icon name="Trash2" size={14}/></button>
                                            </div>
                                            <div className="flex justify-between items-center mb-4">
                                                 {s.status === 'active' && <span className="bg-blue-100 text-blue-800 text-[10px] px-2 py-1 rounded-full">جاري</span>}
                                                 {s.status === 'submitted' && <span className="bg-amber-100 text-amber-800 text-[10px] px-2 py-1 rounded-full">مراجعة</span>}
                                                 {s.status === 'approved' && <span className="bg-green-100 text-green-800 text-[10px] px-2 py-1 rounded-full">معتمد</span>}
                                            </div>
                                            <div className="grid grid-cols-4 gap-2">
                                                 <button onClick={() => setModal({type:'view', data: s})} className="bg-gray-50 p-2 rounded text-gray-600 flex justify-center items-center"><Icon name="Eye" size={16}/></button>
                                                 <button onClick={() => setSessionToManageItems(s)} className="bg-blue-50 p-2 rounded text-blue-600 flex justify-center items-center"><Icon name="Box" size={16}/></button>
                                                 {s.status === 'submitted' ? (
                                                     <>
                                                        <button onClick={() => onApproveSession(s.id)} className="bg-green-100 p-2 rounded text-green-700 flex justify-center items-center col-span-2 text-xs font-bold gap-1"><Icon name="Lock" size={14}/> اعتماد</button>
                                                     </>
                                                 ) : s.status === 'approved' ? (
                                                     <button onClick={() => handleExport(s)} className="bg-green-50 p-2 rounded text-green-600 flex justify-center items-center col-span-2 text-xs font-bold gap-1"><Icon name="FileSpreadsheet" size={14}/> اكسل</button>
                                                 ) : (
                                                     <div className="col-span-2 text-center text-xs text-gray-400 py-2">مشرف</div>
                                                 )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const INITIAL_ITEMS = [
            { id: '1', code: '101', brand: 'المهيدب', name: 'أرز بسمتي', unit: '10 كجم', minQuantity: 10, maxQuantity: 100 },
            { id: '2', code: '102', brand: 'الأسرة', name: 'سكر ناعم', unit: '10 كجم', minQuantity: 5, maxQuantity: 50 },
            { id: '4', code: '201', brand: 'المراعي', name: 'حليب طويل الأجل', unit: 'كرتون 12 حبة', minQuantity: 20, maxQuantity: 200 },
        ];

        const App = () => {
            const [role, setRole] = useState(null);
            const [sites, setSites] = useState(() => JSON.parse(safeStorage.getItem('jarda_sites')) || []);
            const [sessions, setSessions] = useState(() => JSON.parse(safeStorage.getItem('jarda_sessions')) || []);
            const [tplItems, setTplItems] = useState(() => JSON.parse(safeStorage.getItem('jarda_items')) || INITIAL_ITEMS);
            const [supSiteId, setSupSiteId] = useState(null);
            const [supSessId, setSupSessId] = useState(null);

            useEffect(() => safeStorage.setItem('jarda_sites', JSON.stringify(sites)), [sites]);
            useEffect(() => safeStorage.setItem('jarda_sessions', JSON.stringify(sessions)), [sessions]);
            useEffect(() => safeStorage.setItem('jarda_items', JSON.stringify(tplItems)), [tplItems]);

            useEffect(() => {
                const sync = (e) => {
                    if (e.key === 'jarda_sessions' && e.newValue) setSessions(JSON.parse(e.newValue));
                    if (e.key === 'jarda_sites' && e.newValue) setSites(JSON.parse(e.newValue));
                    if (e.key === 'jarda_items') setTplItems(JSON.parse(e.newValue));
                };
                window.addEventListener('storage', sync);
                return () => window.removeEventListener('storage', sync);
            }, []);

            if(!role) return (
                <div className="min-h-dvh bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
                        <div className="bg-primary/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6"><Icon name="LayoutDashboard" className="text-primary" size={32}/></div>
                        <h1 className="text-2xl font-bold mb-8 text-gray-800">منصة جرد الإعاشة</h1>
                        <button onClick={() => setRole('admin')} className="w-full p-4 mb-4 border bg-gray-50 rounded-xl flex items-center gap-4 hover:border-primary transition-all shadow-sm active:scale-95"><Icon name="LayoutDashboard" className="text-blue-600"/> <b>مدير النظام</b></button>
                        <button onClick={() => setRole('supervisor')} className="w-full p-4 border bg-gray-50 rounded-xl flex items-center gap-4 hover:border-secondary transition-all shadow-sm active:scale-95"><Icon name="Users" className="text-amber-600"/> <b>مشرف ميداني</b></button>
                    </div>
                </div>
            );

            if(role === 'admin') return <AdminDashboard sites={sites} sessions={sessions} templateItems={tplItems} 
                onCreateSite={(name) => setSites(p => [...p, {id: Math.random().toString(36).substr(2,9), name}])}
                onRenameSite={(id, name) => { setSites(p => p.map(s => s.id === id ? {...s, name} : s)); setSessions(p => p.map(s => s.siteId === id ? {...s, siteName: name} : s)); }}
                onDeleteSite={(id) => setSites(p => p.filter(s => s.id !== id))}
                onCreateSession={(sid, start, end) => {
                    const site = sites.find(s => s.id === sid);
                    const lastSess = sessions.filter(s => s.siteId === sid).sort((a,b) => b.startDate.localeCompare(a.startDate))[0];
                    setSessions(p => [{id: Math.random().toString(36).substr(2,9), siteId: sid, siteName: site.name, startDate: start, endDate: end, status: 'active', entries: {}, items: sortItems([...(lastSess?.items || tplItems)])}, ...p]);
                }}
                onDeleteSession={(id) => setSessions(p => p.filter(s => s.id !== id))}
                onUpdateSessionDate={(id, start, end) => setSessions(p => p.map(s => s.id === id ? {...s, startDate: start, endDate: end} : s))}
                onApproveSession={(id) => setSessions(p => p.map(s => s.id === id ? {...s, status: 'approved'} : s))}
                onUnapproveSession={(id) => setSessions(p => p.map(s => s.id === id ? {...s, status: 'submitted'} : s))}
                onRequestModification={(id) => setSessions(p => p.map(s => s.id === id ? {...s, status: 'active'} : s))}
                onAddTemplateItem={(i) => setTplItems(p => sortItems([...p, i]))}
                onUpdateTemplateItem={(updatedItem) => setTplItems(p => sortItems(p.map(i => i.id === updatedItem.id ? updatedItem : i)))}
                onDeleteTemplateItem={(id) => setTplItems(p => p.filter(i => i.id !== id))}
                onUpdateSessionItems={(sid, items) => setSessions(p => p.map(s => s.id === sid ? {...s, items: sortItems(items)} : s))}
                onLogout={() => setRole(null)}
            />;

            if(role === 'supervisor') {
                if(supSessId) {
                    const sess = sessions.find(s => s.id === supSessId);
                    if(!sess) return null;
                    if(sess.status === 'approved') return <div className="min-h-dvh flex flex-col items-center justify-center p-4 text-center"><Icon name="CheckCircle" className="text-green-500 mb-4" size={64}/><h2 className="text-2xl font-bold mb-4">تم اعتماد الجرد</h2><Button onClick={() => setSupSessId(null)}>عودة</Button></div>;
                    if(sess.status === 'submitted') return <div className="min-h-dvh flex flex-col items-center justify-center p-4 text-center"><h2 className="text-4xl mb-4">⏳</h2><h2 className="text-2xl font-bold mb-4">بانتظار المراجعة</h2><Button onClick={() => setSupSessId(null)}>عودة</Button></div>;
                    return <SupervisorDashboard session={sess} items={sess.items} onUpdateSession={(u) => setSessions(p => p.map(s => s.id === u.id ? u : s))} onExit={() => setSupSessId(null)}/>;
                }
                if(supSiteId) {
                    const activeSess = sessions.filter(s => s.siteId === supSiteId && s.status !== 'approved');
                    return (
                        <div className="p-4 md:p-6 bg-gray-50 min-h-dvh">
                            <div className="max-w-md mx-auto">
                                <Button variant="outline" onClick={() => setSupSiteId(null)} className="mb-6 text-sm"><Icon name="ArrowRight"/> تغيير الموقع</Button>
                                {activeSess.length === 0 ? <p className="text-center text-gray-400 mt-10">لا يوجد جرد مفتوح حالياً</p> : activeSess.map(s => (
                                    <div key={s.id} onClick={() => setSupSessId(s.id)} className="bg-white p-4 rounded-xl shadow-sm border mb-3 cursor-pointer hover:border-primary flex justify-between items-center active:scale-98 transition-transform">
                                        <div><div className="flex gap-2 font-bold text-gray-800"><Icon name="Calendar" size={16}/><span dir="ltr">{s.startDate}</span></div></div>
                                        <span className={`text-xs px-2 py-1 rounded font-bold ${s.status === 'active' ? 'bg-blue-100 text-blue-800' : 'bg-amber-100 text-amber-800'}`}>{s.status === 'active' ? 'مفتوح' : 'مراجعة'}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    );
                }
                return (
                    <div className="p-4 md:p-6 bg-gray-50 min-h-dvh">
                        <div className="max-w-md mx-auto">
                            <h1 className="text-2xl font-bold mb-8 text-gray-800">اختر الموقع</h1>
                            <Button variant="outline" onClick={() => setRole(null)} className="mb-4 text-sm">خروج</Button>
                            {sites.map(s => <button key={s.id} onClick={() => setSupSiteId(s.id)} className="w-full bg-white p-5 rounded-xl shadow-sm border mb-3 flex gap-4 text-right font-bold items-center active:scale-98 transition-transform"><div className="p-2 bg-gray-100 rounded-lg text-gray-500"><Icon name="Building2"/></div> {s.name}</button>)}
                        </div>
                    </div>
                );
            }
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>